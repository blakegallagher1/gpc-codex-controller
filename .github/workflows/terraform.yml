# Terraform CI workflow for gpc-codex-controller infrastructure.
#
# On pull requests: runs terraform init, fmt -check, validate.
# On push to main: additionally runs terraform fmt/validate/plan.
# On manual workflow_dispatch with input apply=true: runs terraform apply.
#
# Required GitHub repository secrets:
#   HCLOUD_TOKEN          – Hetzner Cloud API token
#   CLOUDFLARE_API_TOKEN  – Cloudflare API token
#   CLOUDFLARE_ACCOUNT_ID – Cloudflare account ID
#   CLOUDFLARE_ZONE_ID    – Cloudflare DNS zone ID
#   TF_VAR_DOMAIN         – Base domain (e.g. example.com)
#
# Optional secrets (used when deploying):
#   TF_VAR_github_token      – GitHub token for PR automation
#   TF_VAR_mcp_bearer_token  – Bearer token for origin service
#   TF_VAR_ssh_public_key    – SSH public key for VM access

name: 'Terraform'

on:
  workflow_dispatch:
    inputs:
      apply:
        description: "Run terraform apply (must be used with persistent/known state)."
        required: false
        default: false
        type: boolean
  push:
    branches: ["main"]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    paths:
      - 'infrastructure/**'
      - '.github/workflows/terraform.yml'

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        shell: bash
        working-directory: infrastructure

    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      TF_VAR_domain: ${{ secrets.TF_VAR_DOMAIN }}
      TF_VAR_render_api_key: ${{ secrets.RENDER_API_KEY }}
      TF_VAR_render_owner_id: ${{ secrets.RENDER_OWNER_ID }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init

    - name: Terraform Format
      run: terraform fmt -check -recursive

    - name: Terraform Validate
      run: terraform validate

    - name: Terraform Plan
      if: |
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
      run: terraform plan -input=false

    - name: Terraform Apply
      if: |
        github.event_name == 'workflow_dispatch' &&
        github.event.inputs.apply == 'true' &&
        github.ref == 'refs/heads/main'
      run: terraform apply -auto-approve -input=false
